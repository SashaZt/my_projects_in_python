# TikTok Stream Monitoring System

Система для отслеживания TikTok стримов, сбора информации о подарках и аналитики.

## Архитектура

Проект построен на модульной архитектуре, где каждый компонент отвечает за отдельную функциональность. Все компоненты взаимодействуют через общее состояние (`SharedState`) и базу данных PostgreSQL.

## Основные компоненты

### 1. main.py

Основной файл для запуска приложения:
- Инициализирует соединение с базой данных
- Создает и запускает `TikTokMonitor`
- Обрабатывает сигналы для корректного завершения работы
- Синхронизирует подарки со стримерами при запуске

### 2. client.py

Основной класс-контроллер для управления системой:
- `TikTokMonitor`: Инициализирует и связывает все компоненты системы
- `start()`: Запускает все процессы мониторинга
- `stop()`: Корректно останавливает все процессы мониторинга
- Проксирует методы других классов для поддержания обратной совместимости

### 3. shared_state.py

Хранит общее состояние и данные, доступные всем компонентам:
- `SharedState`: Содержит общие ресурсы и данные (очереди, флаги и т.д.)
- `get_shutdown_event()`: Возвращает событие завершения работы
- `get_monitored_streams()`: Возвращает словарь отслеживаемых стримов

### 4. stream_monitor.py

Отвечает за мониторинг TikTok стримов:
- `StreamMonitor`: Основной класс для отслеживания стримов
- `_monitor_streamer()`: Подключается к стриму и обрабатывает события
- Обработчики событий:
  - `on_connect`: Обрабатывает подключение к стриму
  - `on_gift`: Обрабатывает полученные подарки
  - `on_disconnect`: Обрабатывает отключение от стрима

### 5. streamer_manager.py

Управляет списком стримеров:
- `StreamerManager`: Основной класс для управления стримерами
- `_update_streamers()`: Периодически обновляет список отслеживаемых стримеров
- `update_streamer()`: Обновляет данные стримера в базе данных
- `debug_tiktok_connection()`: Отладочная функция для проверки подключения

### 6. gift_processor.py

Обрабатывает полученные подарки:
- `GiftProcessor`: Основной класс для обработки подарков
- `_process_gift()`: Обрабатывает событие подарка, извлекает данные и идентифицирует получателя
- `_process_gift_queue()`: Фоновый процесс для сохранения подарков в базу данных
- `_clean_gift_cache()`: Периодически очищает кэш обработанных подарков

### 7. data_sync.py

Отвечает за синхронизацию данных:
- `DataSynchronizer`: Основной класс для синхронизации данных
- `sync_gift_streamers()`: Связывает подарки со стримерами
- `sync_tiktok_ids()`: Синхронизирует TikTok идентификаторы пользователей
- `_schedule_periodic_sync()`: Планирует периодическую синхронизацию

### 8. db.py

Обеспечивает взаимодействие с базой данных:
- `Database`: Основной класс для работы с PostgreSQL
- `connect()`: Устанавливает соединение с базой данных
- `close()`: Закрывает соединение с базой данных
- Методы для выполнения запросов: `execute()`, `fetch()`, `fetchval()`, `fetchrow()`
- Высокоуровневые методы:
  - `get_active_streamers()`: Получает список активных стримеров
  - `update_streamer()`: Обновляет данные стримера
  - `get_or_create_tiktok_user()`: Находит или создает запись о пользователе TikTok

### 9. models.py

Определяет модели данных:
- `Streamer`: Модель стримера
- `Cluster`: Модель кластера стримеров
- `Gift`: Модель подарка
- `Gifter`: Модель донатера
- `DashboardStats`: Модель статистики для дашборда

### 10. logger.py

Настраивает логирование:
- `setup_logging()`: Настраивает логирование в файл и консоль

## Процесс работы

1. Система запускается через `main.py`, который инициализирует соединение с базой данных и создает экземпляр `TikTokMonitor`.
2. `TikTokMonitor` запускает четыре фоновых процесса:
   - Обработка очереди подарков (`_process_gift_queue`)
   - Обновление списка стримеров (`_update_streamers`)
   - Очистка кэша подарков (`_clean_gift_cache`)
   - Периодическая синхронизация (`_schedule_periodic_sync`)
3. `StreamerManager` периодически получает список активных стримеров из базы данных и запускает для каждого задачу `_monitor_streamer`.
4. `StreamMonitor` подключается к стримам TikTok и регистрирует обработчики событий для `ConnectEvent`, `GiftEvent` и `DisconnectEvent`.
5. При получении подарка (`GiftEvent`), `GiftProcessor` обрабатывает его и добавляет в очередь для последующего сохранения в базу данных.
6. `DataSynchronizer` периодически синхронизирует подарки и стримеров, чтобы обеспечить корректную связь между ними.

## Алгоритм идентификации стримеров

1. При подключении к стриму система получает различные идентификаторы (room_id, user_id, tiktok_id).
2. Эти данные сохраняются в базу данных и используются для создания маппинга между различными идентификаторами.
3. При получении подарка система пытается идентифицировать получателя через:
   - Маппинг room_id → tik_tok_user_id
   - Прямой поиск по username (@username)
   - Поиск по user_id
   - Поиск по активным стримам

## Обработка подарков в режиме стрика (streak)

1. Система отслеживает подарки, которые могут быть в стрике (серии).
2. Для стрикабельных подарков учитывается только последний в серии.
3. Для идентификации уникальных подарков используются комбинации идентификаторов и временных меток.

## Синхронизация данных

1. Периодически (каждую минуту) выполняется синхронизация подарков и стримеров.
2. Подарки связываются со стримерами через различные идентификаторы (имя, user_id, tiktok_id, room_id).
3. Автоматически сгенерированные имена (@user_*) заменяются на реальные имена, если они становятся известны.

## Обработка ошибок

1. Система обрабатывает ошибки подключения к стримам и определяет "безопасные" ошибки, которые можно игнорировать.
2. При слишком частых ошибках система увеличивает интервал повторных попыток.
3. Система выполняет отладочное подключение при серьезных ошибках для сбора дополнительной информации.

## База данных

Система использует PostgreSQL с основными таблицами:
- `streamers`: Информация о стримерах
- `tik_tok_users`: Информация о пользователях TikTok
- `gifts`: Записи о полученных подарках
- `streams`: Информация о стримах
- `clusters`: Группы стримеров
- `room_id_mapping`: Связь между room_id и пользователями TikTok

## Дополнительные функции

- Поддержка кластеров стримеров для организации и группировки
- Отслеживание активности стримеров и автоматическое обновление статусов
- Отладочные функции для диагностики проблем с подключением
- Кэширование обработанных подарков для предотвращения дубликатов