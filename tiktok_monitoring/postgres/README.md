### Структура PostgreSQL контейнера

Готовый, хорошо структурированный и масштабируемый шаблон для развертывания PostgreSQL контейнеров. Он обеспечивает правильную инициализацию, настройку производительности, управление схемой и защиту данных в единой, легко адаптируемой форме.

Ваш контейнер PostgreSQL организован следующим образом:

1. **Dockerfile** - основной файл для сборки образа:
   * Использует базовый образ postgres:17
   * Копирует скрипты инициализации в /docker-entrypoint-initdb.d/
   * Имеет настроенную проверку работоспособности (healthcheck)
2. **Скрипты инициализации** - запускаются при первом создании базы данных:
   * **01-config-update.sh** - настраивает параметры PostgreSQL и правила доступа, универсальный для любой PostgreSQL базы
   * **02-init.sql** - создает необходимые расширения PostgreSQL,оздает общие расширения, полезные для большинства проектов
   * **03-schema.sql** - создает схему базы данных (таблицы, индексы и т.д.),**единственный файл, который нужно изменить** для новой схемы БД
3. **update-config.sh** - скрипт для обновления конфигурации существующей базы данных

### Порядок инициализации

Когда вы запускаете контейнер через `./start.sh postgres`:

1. Скрипт  **start.sh** :
   * Проверяет наличие config.json
   * Генерирует .env файл с переменными окружения
   * Проверяет/создает директории для данных PostgreSQL
   * Определяет, нужна ли инициализация базы данных
   * Запускает контейнер PostgreSQL через docker-compose
2. **Docker-инициализация** :

* Если директория данных пуста, PostgreSQL запускает процедуру инициализации
* Выполняются скрипты из /docker-entrypoint-initdb.d/ в алфавитном порядке:
  1. 01-config-update.sh
  2. 02-init.sql
  3. 03-schema.sql
* Создаются пользователь, база данных и схема

1. **Если база уже существует** :

* Docker обнаруживает это и выводит сообщение "Skipping initialization"
* Скрипты инициализации не запускаются
* PostgreSQL запускается с существующими данными

### **Универсальное управление конфигурацией** :

* config_loader.py преобразует JSON в переменные окружения для любой структуры
* update-config.sh работает с любой существующей базой

### Переменные окружения и настройки

Основные переменные окружения из config.json:

* **POSTGRES_USER** ,  **POSTGRES_PASSWORD** , **POSTGRES_DB** - основные параметры БД
* **PGDATA** - путь к данным внутри контейнера
* **PG_** * - переменные для настройки производительности PostgreSQL

### Параметры PostgreSQL, настраиваемые через скрипты:

* `max_connections = 200` - максимальное количество одновременных подключений
* `shared_buffers = 512MB` - объем памяти для кеширования данных
* `effective_cache_size = 1536MB` - ожидаемый объем кеша ОС
* `maintenance_work_mem = 128MB` - память для задач обслуживания
* `checkpoint_completion_target = 0.9` - распределение записи контрольных точек
* `wal_buffers = 16MB` - буфер для журнала транзакций
* `default_statistics_target = 100` - детализация статистики для планировщика
* `random_page_cost = 1.1` - оценка стоимости произвольного доступа (для SSD)
* `effective_io_concurrency = 200` - параллельные операции ввода-вывода
* `work_mem = 6553kB` - память для операций сортировки
* `min_wal_size = 1GB`, `max_wal_size = 4GB` - размеры журнала WAL

### Схема базы данных

Ваша база данных содержит следующие таблицы:

1. **users** - основная таблица пользователей TikTok
2. **user_stats_history** - история статистики пользователей
3. **nickname_history** - история изменений никнейма
4. **unique_id_history** - история изменений unique_id
5. **live_streams** - данные о прямых трансляциях
6. **daily_live_analytics** - агрегированная дневная статистика

Также есть партиционированная таблица **user_stats_history_partitioned** для эффективного хранения большого объема исторических данных.

### Объем данных и производительность

* Партиционирование таблицы **user_stats_history_partitioned** по времени позволяет эффективно работать с большими объемами данных
* Многочисленные индексы ускоряют поиск и фильтрацию
* Настройки PostgreSQL оптимизированы для хорошей производительности на большинстве систем

### Управление существующей базой

Если вам нужно обновить настройки существующей базы данных:

docker-compose exec postgres /update-config.sh

Этот скрипт обновит конфигурацию PostgreSQL и правила доступа без повторной инициализации.

### Подключение к базе данных

Вы можете подключиться к базе данных изнутри контейнера:

docker-compose exec postgres psql -U tiktok_user -d tiktok_analytics

Или с хост-машины, если у вас установлен клиент PostgreSQL:

psql -h localhost -p 5432 -U tiktok_user -d tiktok_analytics

Всё настроено и готово к использованию с вашим API-сервисом через Alembic или напрямую через SQLAlchemy.
